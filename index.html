<html>
<head>
  <meta charset="utf-8" />
  <title>Choropleth with MapLibre GL JS</title>
  <link
    href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="style.css"  />
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .popup-table tr:nth-child(even) { background: #fce0b0; }
    .popup-table tr:nth-child(odd) { background: #ffffff; }
    .popup-table tr:nth-child(odd) { background: #ffffff; }
</style>

</head>
<body>
  <div id="map"></div>
  <div id="layer-panel">
    <h3>Layers</h3>

    <!-- Regions -->
    <div class="layer-group">
      <div class="layer-header">
        <input type="checkbox" id="regions-visible" checked>
        <label for="regions-visible" class="layer-title">Regions</label>
      </div>

      <div class="layer-sub">
        <label class="sub-toggle">
          <input type="checkbox" id="regions-labels-visible" checked>
          Labels
        </label>

        <div class="opacity-row">
          <span>Opacity</span>
          <input type="range" id="regions-opacity" min="0" max="1" step="0.05" value="1">
        </div>
      </div>
    </div>

    <!-- Markers -->
    <div class="layer-group">
      <div class="layer-header">
        <span class="layer-title">Markers</span>
      </div>

      <div class="layer-sub">
        <label class="sub-toggle">
          <input type="checkbox" id="marker-default-visible" checked>
          Default Marker
        </label>

        <label class="sub-toggle">
          <input type="checkbox" id="marker-png-visible" checked>
          PNG Marker
        </label>

        <label class="sub-toggle">
          <input type="checkbox" id="marker-html-visible" checked>
          HTML Marker
        </label>
      </div>
    </div>
  </div>


  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script>
    //map initialization
    const map = new maplibregl.Map({
      container: "map",
      style: "https://api.maptiler.com/maps/7ef13454-8f0d-4cf9-a061-d2f4cb08a76d/style.json?key=SWfpfQVfURyYQrAEj6J3", //you may change with your style json.
      center: [14.1, 47.75],
      zoom: 6.8
    });

    
    // ------------------------------------Data Sources and Layers------------------------------------  //
    // Load all GeoJSON data sources and add them as layers
    map.on("load", () => {
      // Add all GeoJSON sources
      map.addSource("amenities", {
        type: "geojson",
        data: "data/amenities.geojson"
      });

      map.addSource("buildings", {
        type: "geojson",
        data: "data/buildings.geojson"
      });

      map.addSource("railway", {
        type: "geojson",
        data: "data/railway.geojson"
      });

      map.addSource("salzburg-boundaries", {
        type: "geojson",
        data: "data/Salzburg_Boundaries.geojson"
      });

      map.addSource("streets", {
        type: "geojson",
        data: "data/streets.geojson"
      });

      map.addSource("train", {
        type: "geojson",
        data: "data/train.geojson"
      });

      // Add layers for amenities (points)
      map.addLayer({
        id: "amenities-layer",
        type: "circle",
        source: "amenities",
        paint: {
          "circle-radius": 6,
          "circle-color": "#ff6b6b",
          "circle-opacity": 0.7
        }
      });

      // Add layers for buildings (polygons)
      map.addLayer({
        id: "buildings-layer",
        type: "fill",
        source: "buildings",
        paint: {
          "fill-color": "#e74c3c",
          "fill-opacity": 0.5
        }
      });

      // Add stroke for buildings
      map.addLayer({
        id: "buildings-outline",
        type: "line",
        source: "buildings",
        paint: {
          "line-color": "#c0392b",
          "line-width": 1
        }
      });

      // Add layers for railway (lines)
      map.addLayer({
        id: "railway-layer",
        type: "line",
        source: "railway",
        paint: {
          "line-color": "#3498db",
          "line-width": 2
        }
      });

      // Add layers for Salzburg boundaries (polygons)
      map.addLayer({
        id: "salzburg-boundaries-layer",
        type: "fill",
        source: "salzburg-boundaries",
        paint: {
          "fill-color": "#f39c12",
          "fill-opacity": 0.3
        }
      });

      // Add stroke for Salzburg boundaries
      map.addLayer({
        id: "salzburg-boundaries-outline",
        type: "line",
        source: "salzburg-boundaries",
        paint: {
          "line-color": "#d68910",
          "line-width": 2
        }
      });

      // Add layers for streets (lines)
      map.addLayer({
        id: "streets-layer",
        type: "line",
        source: "streets",
        paint: {
          "line-color": "#9b59b6",
          "line-width": 1.5
        }
      });

      // Add layers for train (points)
      map.addLayer({
        id: "train-layer",
        type: "circle",
        source: "train",
        paint: {
          "circle-radius": 8,
          "circle-color": "#2ecc71",
          "circle-opacity": 0.8
        }
      });

    }); 


    //------------------------------------markers------------------------------------  //
      //default marker start
      const markerDefault = new maplibregl.Marker()
        .setLngLat([16.3725, 48.2084]);

      markerDefault.addTo(map);
      //default marker end

      //custom marker png start
      const el = document.createElement("div");
      const img = document.createElement("img");
      img.src = "./marker.png";
      img.style.width = "25px";
      img.style.height = "40px";
      el.appendChild(img);

      const markerPNG  = new maplibregl.Marker({ element: el })
        .setLngLat([16.0725, 48.0084])
        .addTo(map);
      //custom marker png end


      //html marker start
      const el1 = document.createElement("div");
      el1.innerHTML = `
        <div style="
            background:#ff5722;
            color:white;
            padding:4px 8px;
            border-radius:6px;
            font-size:12px;
        ">HTML Marker</div>
      `;
      const markerHTML = new maplibregl.Marker({ element: el1 })
        .setLngLat([15.8725, 48.2084])
        .addTo(map);
      //html marker end

      
     // -------------------------------marker popups-----------------------------------------  // 
      // prevent polygon click when point marker is clicked
      markerPNG.getElement().addEventListener("click", (e) => {
        e.stopPropagation();       // prevents polygon popup
        markerPNG.togglePopup();      // shows marker popup
      });

      //marker popup simple way to set popup
      const popup = new maplibregl.Popup({ offset: 25 })
        .setHTML("<h3>Marker Info</h3><p>This is a PNG marker.</p>");

      // Attach popup to marker
      markerPNG.setPopup(popup);


      // Function to build popup HTML content
      function buildPopupHTML(properties) {
        const name = properties.NAME || properties.name || null;

        // Create table rows for all properties except NAME
        const rows = Object.entries(properties)
        .filter(([key]) => key.toLowerCase() !== "name")
        .map(
          ([key, value], i) => `
            <tr style="background:${i % 2 ? "#eddbdb" : "#ffffff"}">
              <td style="padding:4px 6px; color: #272727"><strong>${key}</strong></td>
              <td style="padding:4px 6px;">${value}</td>
            </tr>
          `
        )
        .join("");


        return `
          <div style="
            max-width: 260px;
            font-family: sans-serif;
          ">
            ${name ? `<h3 style="
                margin: 0 0 8px 0;
                font-size: 16px;
                font-weight: bold;
                border-bottom: 1px solid #ccc;
                padding: 7px;
                background: #eccaca;
                color: #272727;
            ">${name}</h3>` : ""}

            <div style="
              max-height: 150px;
              overflow-y: auto;
              border: 1px solid #ddd;
              border-radius: 4px;
            ">
              <table style="
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
              ">
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
    }

    // Add click event to show popup    
    map.on("click", "regions-fill", (e) => {
    const props = e.features[0].properties;

    new maplibregl.Popup({ closeButton: true })
        .setLngLat(e.lngLat)
        .setHTML(buildPopupHTML(props))
        .addTo(map);
    });

    // Add click events for all layers to show popups
    const layersWithPopups = [
      "amenities-layer",
      "buildings-layer",
      "railway-layer",
      "salzburg-boundaries-layer",
      "streets-layer",
      "train-layer"
    ];

    layersWithPopups.forEach(layerId => {
      map.on("click", layerId, (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup({ closeButton: true })
          .setLngLat(e.lngLat)
          .setHTML(buildPopupHTML(props))
          .addTo(map);
      });
    });


    //--------------------------------mouseover effect------------------------------------  //
    let hoveredFeatureId = null;

    map.on("mousemove", "regions-fill", (e) => {
      if (!e.features.length) return;

      const feature = e.features[0];
      if (hoveredFeatureId !== null && hoveredFeatureId !== feature.id) {
        map.setFeatureState(
          { source: "regions", id: hoveredFeatureId },
          { hover: false }
        );
      }

      hoveredFeatureId = feature.id;

      map.setFeatureState(
        { source: "regions", id: hoveredFeatureId },
        { hover: true }
      );
    });

    map.on("mouseleave", "regions-fill", () => {
      if (hoveredFeatureId !== null) {
        map.setFeatureState(
          { source: "regions", id: hoveredFeatureId },
          { hover: false }
        );
      }
      hoveredFeatureId = null;
    });



    //--------------------------------cursor pointer on layers during hover------------------------------------  //
    // Change cursor to pointer when hovering over interactive layers
    map.on("load", () => {
      map.on("mousemove", (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: ["regions-fill", "regions-outline", "regions-labels"]
        });

        if (features.length) {
          map.getCanvas().style.cursor = "pointer";
        } else {
          map.getCanvas().style.cursor = "";
        }
      });

    
      markerDefault.getElement().style.cursor = "pointer";
      markerPNG.getElement().style.cursor = "pointer";  
      markerHTML.getElement().style.cursor = "pointer";
    });




  </script>
  <!-- main.js includes the layers and other map logic--> 
  <script src="main.js"></script>
</body>
</html>
